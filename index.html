<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Guia do Estudante</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body data-theme="light">
  <header class="top-bar">
    <img src="https://i.im.ge/2025/04/11/pVTi0z.logo.png" alt="logo" />
    <h1>Guia do Estudante</h1>
    <!-- Bot√£o de Modo Escuro -->
    <button class="theme-toggle-btn" onclick="toggleTheme()">
      <span id="theme-icon">üåô</span>
    </button>
  </header>

  <main class="app">
    <!-- TELA DE SELE√á√ÉO: Login do Aluno E ADMIN -->
    <section class="tela ativo" id="tela-selecao">
      <h1 style="font-size: 28px; display: flex; align-items: center; justify-content: center; gap: 10px;">
        üëã Acesso ao Guia
      </h1>
      <p style="text-align: center; margin-bottom: 25px; color: var(--color-secundary);">
        Preencha seus dados para come√ßar:
      </p>

      <label for="nome">Nome Completo:</label>
      <input type="text" id="nome" class="campo" placeholder="Ex: Maria Silva">

      <label for="curso">Curso:</label>
      <select id="curso" class="campo">
        <option value="" disabled selected>Escolha o curso</option>
        <option>Inform√°tica</option>
        <option>An√°lises Cl√≠nicas</option>
        <option>Nutri√ß√£o</option>
        <option>Edifica√ß√µes</option>
        <option>Qu√≠mica</option>
        <option>Meio Ambiente</option>
      </select>

      <label for="ano">Ano:</label>
      <select id="ano" class="campo">
        <option value="" disabled selected>Selecione o ano</option>
        <option>1¬∫ Ano</option>
        <option>2¬∫ Ano</option>
        <option>3¬∫ Ano</option>
      </select>

      <button class="btn" onclick="entrar()" style="margin-top: 20px;">
        ACESSAR O MEU GUIA (ALUNO)
      </button>
      
      <!-- Toggle para Acesso Admin -->
      <button class="btn admin-btn" id="btn-toggle-admin" onclick="toggleAdminLoginFields(event)" style="margin-top: 15px; background: #333; color: white;">
        ‚öôÔ∏è Acesso Administrativo
      </button>
      
      <div id="admin-login-fields" style="display: none; margin-top: 20px; padding: 15px; border-radius: 12px; background: var(--color-background-darker);">
        <p style="text-align: center; margin-bottom: 15px; font-weight: bold; color: var(--color-text-main);">
            Insira a senha do Professor:
        </p>

        <label for="senha-admin">Senha:</label>
        <input type="password" id="senha-admin" class="campo" placeholder="Senha do Professor">

        <button class="btn btn-action" onclick="logarAdmin()" style="margin-top: 10px; background: linear-gradient(90deg, #ff6b6b, #ff4757);">
            ENTRAR NO PAINEL ADMIN
        </button>
      </div>
      
      <p id="auth-status" style="margin-top: 15px; font-size: 12px; color: var(--color-text-subtle); text-align: center;"></p>

    </section>
    
    <!-- TELA INICIAL: ADICIONADO ALERTA DE NOTIFICA√á√ïES E NOVO BOT√ÉO -->
    <section class="tela" id="tela-inicial">
      <h1 id="info-aluno">Menu Principal</h1>
      
      <!-- CARD DE NOTIFICA√á√ïES/ALERTAS -->
      <div id="alertas-proximos" class="card" style="margin-bottom: 25px; display: none; border: 2px solid var(--color-secundary);">
        <!-- Conte√∫do din√¢mico inserido por JavaScript -->
      </div>
      
      <button class="btn" onclick="mudarTela('avisos')">üì£ Mural de Avisos</button>
      <button class="btn" onclick="mudarTela('calendario')">Calend√°rio de Provas</button>
      <button class="btn" onclick="mudarTela('atividades')">Atividades para Entregar</button>
      <button class="btn" onclick="mudarTela('assuntos')">Assuntos</button>
      <button class="btn" onclick="mudarTela('recursos')">Recursos de Estudo</button> 
      <button class="btn" onclick="mudarTela('professores')">Professores e Contatos</button>
      <button class="btn voltar" onclick="mudarTela('selecao')">‚Üê Trocar Aluno/Curso</button>
    </section>
    
    <!-- TELA DE ADMINISTRA√á√ÉO: ADICIONADO BOT√ÉO DE LIMPEZA -->
    <section class="tela" id="tela-admin">
      <h1>Painel do Administrador</h1>
      <p>Selecione o que deseja cadastrar:</p>
      <button class="btn" onclick="mudarTela('adicionar-prova')">‚ûï Cadastrar Prova</button>
      <button class="btn admin-btn" onclick="mudarTela('adicionar-atividade')">üìù Cadastrar Atividade</button>
      <button class="btn admin-btn" onclick="mudarTela('adicionar-aviso')" style="background: linear-gradient(90deg, #10b981, #059669);">üì∞ Cadastrar Aviso</button>
      
      <!-- BOT√ÉO DE LIMPEZA -->
      <button class="btn voltar" onclick="limparItensAntigos()" style="background: #e67e22; border: none; margin-top: 20px;">üßπ Limpar Itens Antigos</button>
      
      <button class="btn voltar" onclick="mudarTela('inicial')" style="margin-top: 5px;">‚Üê Voltar ao Menu</button>
    </section>

    <!-- FORMUL√ÅRIO DE PROVA -->
    <section class="tela" id="tela-adicionar-prova">
      <h1>Cadastrar Nova Prova</h1>
      <label for="prova-data">Data (DD/MM/AAAA):</label>
      <!-- Alterado para suportar AAAA para melhor compara√ß√£o no Firestore -->
      <input type="text" id="prova-data" class="campo" placeholder="Ex: 25/11/2025" maxlength="10">

      <label for="prova-materia">Mat√©ria:</label>
      <input type="text" id="prova-materia" class="campo" placeholder="Ex: Qu√≠mica">

      <label for="prova-assunto">Assunto:</label>
      <input type="text" id="prova-assunto" class="campo" placeholder="Ex: Balanceamento Qu√≠mico">

      <button class="btn" onclick="adicionarProva()">Salvar Prova</button>
      <button class="btn voltar" onclick="mudarTela('admin')">‚Üê Voltar</button>
    </section>
    
    <!-- FORMUL√ÅRIO: CADASTRO DE ATIVIDADE -->
    <section class="tela" id="tela-adicionar-atividade">
      <h1>Cadastrar Nova Atividade</h1>
      <label for="atividade-nome">Nome da Atividade:</label>
      <input type="text" id="atividade-nome" class="campo" placeholder="Ex: Resumo Cap. 5">

      <label for="atividade-materia">Mat√©ria:</label>
      <input type="text" id="atividade-materia" class="campo" placeholder="Ex: Portugu√™s">

      <label for="atividade-data-entrega">Data de Entrega (DD/MM/AAAA):</label>
       <!-- Alterado para suportar AAAA para melhor compara√ß√£o no Firestore -->
      <input type="text" id="atividade-data-entrega" class="campo" placeholder="Ex: 10/12/2025" maxlength="10">

      <button class="btn" onclick="adicionarAtividade()">Salvar Atividade</button>
      <button class="btn voltar" onclick="mudarTela('admin')">‚Üê Voltar</button>
    </section>
    
    <!-- FORMUL√ÅRIO: CADASTRO DE AVISO (ADMIN) -->
    <section class="tela" id="tela-adicionar-aviso">
      <h1>Cadastrar Novo Aviso</h1>
      <label for="aviso-titulo">T√≠tulo:</label>
      <input type="text" id="aviso-titulo" class="campo" placeholder="Ex: Mudan√ßa de hor√°rio de aula">

      <label for="aviso-texto">Mensagem:</label>
      <textarea id="aviso-texto" class="campo" rows="4" placeholder="Detalhes do aviso..."></textarea>
      
      <button class="btn" onclick="adicionarAviso()" style="background: linear-gradient(90deg, #10b981, #059669); color: white;">Publicar Aviso</button>
      <button class="btn voltar" onclick="mudarTela('admin')">‚Üê Voltar</button>
    </section>

    <!-- TELA DE CALEND√ÅRIO -->
    <section class="tela" id="tela-calendario">
      <h1>Calend√°rio de Provas</h1>
      <div id="lista-provas">
        <!-- Provas din√¢micas ser√£o inseridas aqui -->
        <p class="empty-list-message">Carregando provas...</p>
      </div>
      <button class="btn voltar" onclick="mudarTela('inicial')">‚Üê Voltar</button>
    </section>
    
    <!-- TELA DO MURAL DE AVISOS (ALUNO) -->
    <section class="tela" id="tela-avisos">
      <h1>Mural de Avisos da Escola</h1>
      <div id="lista-avisos">
        <!-- Avisos din√¢micos ser√£o inseridos aqui -->
        <p class="empty-list-message">Carregando avisos...</p>
      </div>
      <button class="btn voltar" onclick="mudarTela('inicial')">‚Üê Voltar</button>
    </section>


    <!-- TELA: ATIVIDADES PARA ENTREGAR (ALUNO) -->
    <section class="tela" id="tela-atividades">
      <h1>Atividades para Entregar</h1>
      <div id="lista-atividades">
        <!-- Atividades cadastradas pelo Admin ser√£o inseridas aqui -->
        <p class="empty-list-message">Carregando atividades...</p>
      </div>
      <button class="btn voltar" onclick="mudarTela('inicial')">‚Üê Voltar</button>
    </section>

    <!-- TELA DE ASSUNTOS -->
    <section class="tela" id="tela-assuntos">
      <h1>Assuntos por Mat√©ria</h1>
      <p style="margin-bottom: 20px;">Lista de t√≥picos essenciais para cada disciplina. Utilize como guia para revis√µes.</p>
      <ul id="lista-assuntos">
        <p class="empty-list-message">Conte√∫do de Assuntos ser√° cadastrado pelo Admin em uma futura atualiza√ß√£o.</p>
      </ul>
      <button class="btn voltar" onclick="mudarTela('inicial')">‚Üê Voltar</button>
    </section>

    <!-- TELA DE RECURSOS DE ESTUDO -->
    <section class="tela" id="tela-recursos">
      <h1>üìö Recursos de Estudo</h1>
      <p style="margin-bottom: 20px;">Materiais de apoio e links importantes fornecidos pelos professores.</p>
      <ul id="lista-recursos">
        <p class="empty-list-message">Nenhum link ou material de apoio cadastrado.</p>
      </ul>
      <button class="btn voltar" onclick="mudarTela('inicial')">‚Üê Voltar</button>
    </section>

    <!-- TELA PROFESSORES: Contatos √öteis atualizados com o link da Ouvidoria -->
    <section class="tela" id="tela-professores">
      <h1>Professores e Contatos</h1>
      
      <h2 style="margin-top: 20px;">Contatos √öteis da Escola</h2>
      <ul id="lista-contatos-uteis">
        <li>Secretaria: (99) 9999-9999</li>
        <li>Coordena√ß√£o: (99) 8888-8888</li>
        <!-- LINK DA OUVIDORIA ATUALIZADO -->
        <li><a href="https://ouvidoria-cetep-lnab-yitb.onrender.com/" target="_blank">Ouvidoria da Escola (Clique aqui)</a></li> 
      </ul>

      <h2 style="margin-top: 20px;">Professores</h2>
      <ul id="lista-professores">
        <p class="empty-list-message">Nenhum professor cadastrado para este curso/ano.</p>
      </ul>

      <button class="btn voltar" onclick="mudarTela('inicial')">‚Üê Voltar</button>
    </section>
  </main>

  <script type="module">
    // --- IMPORTA√á√ïES DO FIREBASE (MANDAT√ìRIO) ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { 
        getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, 
        setPersistence, browserLocalPersistence
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
        getFirestore, doc, setDoc, addDoc, onSnapshot, collection, query, orderBy, 
        deleteDoc, getDocs, where, limit, runTransaction, Timestamp, 
        setLogLevel // Adicionado para logs de debug
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- VARI√ÅVEIS GLOBAIS DE AMBIENTE E CONFIGURA√á√ÉO ---
    const SENHA_ADMIN = "1234"; 
    const STORAGE_USER_KEY = 'guiaEstudante_user';
    const STORAGE_THEME_KEY = 'guiaEstudante_theme';
    
    // Configura√ß√µes e Inst√¢ncias do Firebase
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    
    let app, db, auth;
    let userId = null; // ID do usu√°rio autenticado (UID)
    let isAuthReady = false; // Flag para garantir que o Firestore s√≥ comece a ouvir depois da autentica√ß√£o

    // --- Caminhos do Firestore (P√∫blico para dados compartilhados da escola) ---
    const getCollectionPath = (collectionName) => 
      `/artifacts/${appId}/public/data/${collectionName}`;
    
    const COLLECTION_PROVAS = getCollectionPath('provas');
    const COLLECTION_ATIVIDADES = getCollectionPath('atividades');
    const COLLECTION_AVISOS = getCollectionPath('avisos');
    const COLLECTION_ENVIOS = getCollectionPath('envios'); // Status de envio por aluno

    // --- Inicializa√ß√£o do Firebase ---
    async function initializeFirebase() {
        if (Object.keys(firebaseConfig).length === 0) {
            console.error("Firebase config n√£o encontrada. O aplicativo ser√° executado sem persist√™ncia.");
            return;
        }

        try {
            // setLogLevel('Debug'); // Ativar logs de debug
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            // Persist√™ncia local para manter o estado do usu√°rio
            await setPersistence(auth, browserLocalPersistence);

            // Tenta logar com o token customizado
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                // Caso contr√°rio, usa login an√¥nimo
                await signInAnonymously(auth);
            }
            
            // Listener de estado de autentica√ß√£o
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    document.getElementById('auth-status').textContent = `Autenticado. UID: ${userId}`;
                    
                    // Se o usu√°rio j√° est√° logado no localStorage, inicia a tela
                    const userInfo = JSON.parse(localStorage.getItem(STORAGE_USER_KEY));
                    if (userInfo) {
                        loadUserInfo(userInfo);
                        startListeners(); // Inicia os listeners do Firestore
                    }
                } else {
                    isAuthReady = false;
                    document.getElementById('auth-status').textContent = 'Aguardando autentica√ß√£o...';
                }
            });

        } catch (error) {
            console.error("Erro ao inicializar Firebase ou autenticar:", error);
            document.getElementById('auth-status').textContent = `Erro de Autentica√ß√£o. Recarregue.`;
        }
    }
    
    // --- Listener de Dados (Real-time) ---
    let unsubscribeProvas;
    let unsubscribeAtividades;
    let unsubscribeAvisos;
    
    function startListeners() {
        if (!isAuthReady || !db) return;

        // Listener para Provas (Carregado na tela inicial, filtrado na tela calend√°rio)
        const qProvas = query(collection(db, COLLECTION_PROVAS), orderBy('timestamp', 'asc'));
        unsubscribeProvas = onSnapshot(qProvas, (snapshot) => {
            const provas = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            window.provasData = provas; // Armazena globalmente para acesso f√°cil
            if (document.querySelector('#tela-calendario').classList.contains('ativo')) {
                carregarProvas();
            }
            verificarAlertas();
        }, error => console.error("Erro ao carregar provas:", error));

        // Listener para Atividades
        const qAtividades = query(collection(db, COLLECTION_ATIVIDADES), orderBy('timestamp', 'asc'));
        unsubscribeAtividades = onSnapshot(qAtividades, (snapshot) => {
            const atividades = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            window.atividadesData = atividades; // Armazena globalmente para acesso f√°cil
            if (document.querySelector('#tela-atividades').classList.contains('ativo')) {
                carregarAtividades();
            }
            verificarAlertas();
        }, error => console.error("Erro ao carregar atividades:", error));

        // Listener para Avisos
        const qAvisos = query(collection(db, COLLECTION_AVISOS), orderBy('timestamp', 'desc'), limit(50));
        unsubscribeAvisos = onSnapshot(qAvisos, (snapshot) => {
            const avisos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            window.avisosData = avisos; // Armazena globalmente para acesso f√°cil
            if (document.querySelector('#tela-avisos').classList.contains('ativo')) {
                carregarAvisos();
            }
        }, error => console.error("Erro ao carregar avisos:", error));
    }


    // --- Fun√ß√µes de Inicializa√ß√£o e Tema ---

    document.addEventListener('DOMContentLoaded', () => {
        loadTheme();
        initializeFirebase(); // Inicia o Firebase na carga da p√°gina
        // O loadUserInfo e startListeners ser√£o chamados ap√≥s a autentica√ß√£o
    });

    function loadTheme() {
        const savedTheme = localStorage.getItem(STORAGE_THEME_KEY) || 'light';
        document.body.setAttribute('data-theme', savedTheme);
        document.getElementById('theme-icon').textContent = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
    }

    function toggleTheme() {
        const currentTheme = document.body.getAttribute('data-theme');
        const newTheme = currentTheme === 'light' ? 'dark' : 'light';
        document.body.setAttribute('data-theme', newTheme);
        localStorage.setItem(STORAGE_THEME_KEY, newTheme);
        document.getElementById('theme-icon').textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
    }
    
    function loadUserInfo(userInfo) {
         document.getElementById('info-aluno').textContent = `Bem-vindo(a), ${userInfo.nome} (${userInfo.ano} - ${userInfo.curso})`;
         document.getElementById('nome').value = userInfo.nome;
         document.getElementById('curso').value = userInfo.curso;
         document.getElementById('ano').value = userInfo.ano;
         mudarTela('inicial', false);
         verificarAlertas();
    }


    // --- Fun√ß√µes de Navega√ß√£o e Autentica√ß√£o (Mantidas) ---

    window.toggleAdminLoginFields = function(event) {
        event.preventDefault(); 
        const fields = document.getElementById('admin-login-fields');
        const toggleBtn = document.getElementById('btn-toggle-admin');
        
        if (fields.style.display === 'none' || fields.style.display === '') {
            fields.style.display = 'block';
            toggleBtn.textContent = 'Ocultar Acesso Administrativo';
            toggleBtn.style.background = '#444'; 
        } else {
            fields.style.display = 'none';
            toggleBtn.textContent = '‚öôÔ∏è Acesso Administrativo';
            toggleBtn.style.background = '#333';
        }
    }

    window.logarAdmin = function() {
        const senhaInput = document.getElementById('senha-admin');
        const senha = senhaInput.value;

        if (senha === SENHA_ADMIN) {
            senhaInput.value = '';
            document.getElementById('admin-login-fields').style.display = 'none';
            document.getElementById('btn-toggle-admin').textContent = '‚öôÔ∏è Acesso Administrativo';
            document.getElementById('btn-toggle-admin').style.background = '#333';

            mudarTela('admin', false);
        } else {
            console.error("Senha incorreta. Acesso negado.");
            senhaInput.value = '';
        }
    }


    window.mudarTela = function(telaId, checkAuth = true) {
      const telas = document.querySelectorAll('.tela');
      telas.forEach(tela => tela.classList.remove('ativo'));
      document.getElementById(`tela-${telaId}`).classList.add('ativo');
      
      if (telaId === 'inicial') {
        verificarAlertas();
      } else if (telaId === 'calendario') {
        carregarProvas();
      } else if (telaId === 'atividades') {
        carregarAtividades();
      } else if (telaId === 'avisos') { 
        carregarAvisos();
      } else if (telaId === 'selecao') {
        // N√£o faz nada no localStorage, apenas troca a tela
      }
    }

    window.entrar = function() {
      const nome = document.getElementById('nome').value.trim();
      const curso = document.getElementById('curso').value;
      const ano = document.getElementById('ano').value;
      
      if (!nome || !curso || !ano) {
        console.error('Por favor, preencha seu nome, curso e ano.');
        return;
      }
      
      const userInfo = { nome, curso, ano };
      localStorage.setItem(STORAGE_USER_KEY, JSON.stringify(userInfo));

      loadUserInfo(userInfo);
    }

    // --- Fun√ß√µes de Notifica√ß√£o e Datas (Adaptadas para AAAA) ---
    
    /** * Converte data DD/MM/AAAA para um Timestamp Unix.
     * @param {string} dataStr - Data no formato DD/MM/AAAA.
     * @returns {number|null} Timestamp da data alvo √† meia-noite, ou null se formato inv√°lido.
     */
    function dataParaTimestamp(dataStr) {
      const partes = dataStr.split('/');
      if (partes.length !== 3) return null;
      const dia = parseInt(partes[0]);
      const mes = parseInt(partes[1]) - 1; // M√™s √© zero-based (0=Jan)
      const ano = parseInt(partes[2]);

      // Verifica se a data √© v√°lida
      if (isNaN(dia) || isNaN(mes) || isNaN(ano)) return null;
      
      const dataAlvo = new Date(ano, mes, dia);
      dataAlvo.setHours(0, 0, 0, 0); // Define para meia-noite

      // Verifica se a data √© razo√°vel (por exemplo, ap√≥s 2024 e menos de 10 anos futuro)
      if (dataAlvo.getFullYear() < 2024 || dataAlvo.getFullYear() > new Date().getFullYear() + 10) {
          console.warn(`Data ${dataStr} parece inv√°lida ou muito distante.`);
          return null;
      }

      return dataAlvo.getTime();
    }
    
    function getTodayTimestamp() {
        const hoje = new Date();
        hoje.setHours(0, 0, 0, 0);
        return hoje.getTime();
    }

    window.verificarAlertas = async function() {
      if (!isAuthReady || !window.provasData || !window.atividadesData) {
          // Espera os dados serem carregados pelos listeners
          document.getElementById('alertas-proximos').style.display = 'none';
          return;
      }
        
      const hojeTs = getTodayTimestamp();
      
      // Intervalo de alerta: at√© 3 dias a partir de hoje
      const limiteAlerta = new Date(hojeTs);
      limiteAlerta.setDate(limiteAlerta.getDate() + 4); 
      const limiteAlertaTs = limiteAlerta.getTime();
      
      let provasProximas = 0;
      let atividadesProximas = 0;
      let atividadesPendentes = 0;
      
      const provas = window.provasData || [];
      const atividades = window.atividadesData || [];
      const statusEnvio = await obterStatusEnvio(); // Busca status de envio do Firestore

      // 1. Provas
      provas.forEach(p => {
        const provaTs = dataParaTimestamp(p.data);
        if (provaTs && provaTs >= hojeTs && provaTs < limiteAlertaTs) {
          provasProximas++;
        }
      });
      
      // 2. Atividades
      atividades.forEach(a => {
        // Verifica se a atividade foi enviada
        if (!statusEnvio[a.id] || statusEnvio[a.id].status !== 'enviada') {
            atividadesPendentes++;
            
            const atividadeTs = dataParaTimestamp(a.dataEntrega);
            if (atividadeTs && atividadeTs >= hojeTs && atividadeTs < limiteAlertaTs) {
              atividadesProximas++;
            }
        }
      });

      const alertaElemento = document.getElementById('alertas-proximos');
      let htmlAlerta = '<h2>üö® Alertas de Organiza√ß√£o</h2>';
      let temAlertaUrgente = false;

      if (provasProximas > 0) {
        htmlAlerta += `<p>‚Ä¢ üìÖ ${provasProximas} Prova(s) marcada(s) para os pr√≥ximos 3 dias. Estude!</p>`;
        temAlertaUrgente = true;
      }
      if (atividadesProximas > 0) {
        htmlAlerta += `<p>‚Ä¢ üìù ${atividadesProximas} Atividade(s) com entrega nos pr√≥ximos 3 dias.</p>`;
        temAlertaUrgente = true;
      }
      if (atividadesPendentes > 0) {
        htmlAlerta += `<p>‚Ä¢ ‚è≥ Voc√™ tem ${atividadesPendentes} atividade(s) pendente(s) no total.</p>`;
      }
      
      if (!temAlertaUrgente && atividadesPendentes === 0) {
        htmlAlerta = '<h2>‚úÖ Tudo em Ordem!</h2><p>Nenhuma prova ou entrega urgente para os pr√≥ximos dias.</p>';
        alertaElemento.style.borderColor = 'var(--color-success)';
      } else if (!temAlertaUrgente && atividadesPendentes > 0) {
        htmlAlerta = `<h2>üëç Sem Urg√™ncia</h2><p>Voc√™ tem ${atividadesPendentes} atividade(s) pendente(s), mas sem prazo para os pr√≥ximos 3 dias.</p>`;
        alertaElemento.style.borderColor = 'var(--color-secundary)';
      } else {
        alertaElemento.style.borderColor = 'var(--color-alert)';
      }
      
      alertaElemento.innerHTML = htmlAlerta;
      alertaElemento.style.display = 'block';
    }


    // --- FUN√á√ÉO DE LIMPEZA GERAL (FIREBASE) ---

    window.limparItensAntigos = async function() {
        if (!isAuthReady || !db) return console.error("Firebase n√£o est√° pronto.");
        
        const hojeTs = getTodayTimestamp();
        const batch = db.batch();
        let provasRemovidas = 0;
        let atividadesRemovidas = 0;
        let avisosRemovidos = 0;
        
        try {
            // 1. Limpa Provas Passadas
            const provasSnapshot = await getDocs(collection(db, COLLECTION_PROVAS));
            provasSnapshot.forEach(doc => {
                const p = doc.data();
                const provaTs = dataParaTimestamp(p.data);
                if (provaTs !== null && provaTs < hojeTs) {
                    batch.delete(doc.ref);
                    provasRemovidas++;
                }
            });
            
            // 2. Limpa Atividades Passadas
            const atividadesSnapshot = await getDocs(collection(db, COLLECTION_ATIVIDADES));
            atividadesSnapshot.forEach(doc => {
                const a = doc.data();
                const atividadeTs = dataParaTimestamp(a.dataEntrega);
                if (atividadeTs !== null && atividadeTs < hojeTs) {
                    batch.delete(doc.ref);
                    atividadesRemovidas++;
                }
            });

            // 3. Limpa Avisos com mais de 30 dias (usando a data de cria√ß√£o no Firestore)
            const limite30Dias = Timestamp.fromDate(new Date(hojeTs - (30 * 24 * 60 * 60 * 1000)));
            const qAvisosAntigos = query(collection(db, COLLECTION_AVISOS), where('timestamp', '<', limite30Dias));
            const avisosSnapshot = await getDocs(qAvisosAntigos);
            avisosSnapshot.forEach(doc => {
                batch.delete(doc.ref);
                avisosRemovidos++;
            });

            await batch.commit();

            let mensagem = `Limpeza conclu√≠da!
            
            - ${provasRemovidas} prova(s) passada(s) removida(s).
            - ${atividadesRemovidas} atividade(s) passada(s) removida(s).
            - ${avisosRemovidos} aviso(s) com mais de 30 dias removido(s).
            
            O Guia do Estudante est√° mais organizado! (Os dados ser√£o atualizados em segundos)`;
            
            console.log(mensagem);
            
            const btn = document.querySelector('#tela-admin .btn[onclick="limparItensAntigos()"]');
            btn.textContent = "üßπ Limpeza Conclu√≠da!";
            setTimeout(() => {
                btn.textContent = "üßπ Limpar Itens Antigos";
            }, 3000);

            mudarTela('admin');
        } catch (error) {
            console.error("Erro ao limpar itens antigos no Firebase:", error);
        }
    }


    // --- Fun√ß√µes de Gest√£o de Provas (Admin/Aluno - FIREBASE) ---

    window.adicionarProva = async function() {
      if (!isAuthReady || !db) return console.error("Firebase n√£o est√° pronto.");
        
      const dataInput = document.getElementById('prova-data');
      const materiaInput = document.getElementById('prova-materia');
      const assuntoInput = document.getElementById('prova-assunto');

      const data = dataInput.value.trim();
      const materia = materiaInput.value.trim();
      const assunto = assuntoInput.value.trim();
      
      if (!data || !materia || !assunto) {
        console.error('Por favor, preencha todos os campos da prova.');
        return;
      }
      
      if (dataParaTimestamp(data) === null) {
          console.error('Formato de data inv√°lido. Use DD/MM/AAAA.');
          return;
      }

      try {
          await addDoc(collection(db, COLLECTION_PROVAS), {
            data,
            materia,
            assunto,
            timestamp: Timestamp.now()
          });

          console.log(`Prova de ${materia} em ${data} adicionada com sucesso!`);

          dataInput.value = '';
          materiaInput.value = '';
          assuntoInput.value = '';
          mudarTela('admin');
          
      } catch (error) {
          console.error("Erro ao adicionar prova:", error);
      }
    }

    window.carregarProvas = function() {
      const listaProvasElemento = document.getElementById('lista-provas');
      const provas = window.provasData || []; // Usa os dados carregados pelo listener
      
      if (provas.length === 0) {
        listaProvasElemento.innerHTML = `<p class="empty-list-message">Nenhuma prova cadastrada pelo Admin.</p>`;
        return;
      }
      
      const hojeTs = getTodayTimestamp();

      // Filtra e ordena as provas futuras (j√° est√£o ordenadas por data pelo query)
      const provasFuturas = provas.filter(p => dataParaTimestamp(p.data) !== null && dataParaTimestamp(p.data) >= hojeTs);
      
      if (provasFuturas.length === 0) {
        listaProvasElemento.innerHTML = `<p class="empty-list-message">Nenhuma prova futura cadastrada.</p>`;
        return;
      }

      let htmlProvas = provasFuturas.map(prova => `
          <div class="card">
            <h2>üìÖ ${prova.data} - ${prova.materia}</h2>
            <p>Assunto: ${prova.assunto}</p>
          </div>
        `).join('');
      
      listaProvasElemento.innerHTML = htmlProvas;
    }

    // --- Fun√ß√µes de Gest√£o de ATIVIDADES (Professor/Admin - FIREBASE) ---

    window.adicionarAtividade = async function() {
        if (!isAuthReady || !db) return console.error("Firebase n√£o est√° pronto.");
        
        const nomeInput = document.getElementById('atividade-nome');
        const materiaInput = document.getElementById('atividade-materia');
        const dataEntregaInput = document.getElementById('atividade-data-entrega');

        const nome = nomeInput.value.trim();
        const materia = materiaInput.value.trim();
        const dataEntrega = dataEntregaInput.value.trim();

        if (!nome || !materia || !dataEntrega) {
            console.error('Por favor, preencha todos os campos da atividade.');
            return;
        }
        
        if (dataParaTimestamp(dataEntrega) === null) {
          console.error('Formato de data inv√°lido. Use DD/MM/AAAA.');
          return;
        }

        try {
            await addDoc(collection(db, COLLECTION_ATIVIDADES), {
                nome,
                materia,
                dataEntrega,
                timestamp: Timestamp.now()
            });

            console.log(`Atividade "${nome}" cadastrada com sucesso!`);

            nomeInput.value = '';
            materiaInput.value = '';
            dataEntregaInput.value = '';
            mudarTela('admin');
            
        } catch (error) {
            console.error("Erro ao adicionar atividade:", error);
        }
    }
    
    // --- Fun√ß√µes de Gest√£o de AVISOS (Professor/Admin - FIREBASE) ---

    window.adicionarAviso = async function() {
      if (!isAuthReady || !db) return console.error("Firebase n√£o est√° pronto.");
        
      const tituloInput = document.getElementById('aviso-titulo');
      const textoInput = document.getElementById('aviso-texto');
      
      const titulo = tituloInput.value.trim();
      const texto = textoInput.value.trim();

      if (!titulo || !texto) {
        console.error('Por favor, preencha o t√≠tulo e a mensagem do aviso.');
        return;
      }

      try {
          await addDoc(collection(db, COLLECTION_AVISOS), {
            titulo,
            texto,
            // A data de publica√ß√£o √© inferida do timestamp para fins de exibi√ß√£o
            data: new Date().toLocaleDateString('pt-BR'),
            timestamp: Timestamp.now()
          });

          console.log(`Aviso "${titulo}" publicado com sucesso!`);

          tituloInput.value = '';
          textoInput.value = '';
          mudarTela('admin');
          
      } catch (error) {
          console.error("Erro ao adicionar aviso:", error);
      }
    }

    window.carregarAvisos = function() {
      const listaAvisosElemento = document.getElementById('lista-avisos');
      const avisos = window.avisosData || []; // Usa os dados carregados pelo listener

      if (avisos.length === 0) {
        listaAvisosElemento.innerHTML = '<p class="empty-list-message" style="color: var(--color-text-main);">Nenhum aviso geral publicado pela escola at√© o momento.</p>';
        return;
      }

      let htmlAvisos = avisos.map(aviso => {
          return `
              <div class="card card-aviso">
                  <h2 style="color: var(--color-primary-dark);">${aviso.titulo}</h2>
                  <p style="margin-bottom: 8px;">${aviso.texto.replace(/\n/g, '<br>')}</p>
                  <small style="display: block; text-align: right; color: var(--color-secundary); font-size: 11px;">Publicado em: ${aviso.data}</small>
              </div>
          `;
      }).join('');

      listaAvisosElemento.innerHTML = htmlAvisos;
    }


    // --- Fun√ß√µes de ENVIOS do Aluno (FIREBASE) ---

    /**
     * Obt√©m o status de envio do aluno atual para todas as atividades.
     * @returns {Object} Mapa de {atividadeId: {status: 'enviada', timestamp: ...}}
     */
    async function obterStatusEnvio() {
        if (!isAuthReady || !db || !userId) return {};
        
        // A chave de envio √© o UID do usu√°rio (aluno)
        const docRef = doc(db, COLLECTION_ENVIOS, userId);
        
        try {
            const docSnap = await db.getDoc(docRef);
            if (docSnap.exists()) {
                // Retorna o mapa de atividades (ex: { 'id1': { status: 'enviada', ... } })
                return docSnap.data().atividades || {};
            }
            return {};
        } catch (error) {
            console.error("Erro ao buscar status de envio:", error);
            return {};
        }
    }

    /**
     * Salva o status de envio de uma atividade espec√≠fica.
     */
    async function salvarStatusEnvio(atividadeId, status) {
        if (!isAuthReady || !db || !userId) {
             console.error('Erro: Firebase ou usu√°rio n√£o identificados para salvar o envio.');
             return;
        }

        const docRef = doc(db, COLLECTION_ENVIOS, userId);
        
        try {
            // Usa runTransaction para garantir atomicidade ao atualizar um subcampo
            await runTransaction(db, async (transaction) => {
                const docSnap = await transaction.get(docRef);
                const envios = docSnap.exists() ? docSnap.data().atividades || {} : {};
                
                envios[atividadeId] = {
                    status: status,
                    timestamp: Timestamp.now()
                };

                transaction.set(docRef, { atividades: envios });
            });
            console.log("Status de envio atualizado com sucesso!");
        } catch (error) {
            console.error("Erro ao salvar status de envio:", error);
        }
    }
    
    window.confirmarEnvio = async function(atividadeId) {
        await salvarStatusEnvio(atividadeId, 'enviada');
        // A atualiza√ß√£o da tela ser√° tratada pelo listener na pr√≥xima linha (se o listener estivesse aqui)
        // Como o listener j√° est√° ativo, ele for√ßar√° o recarregamento.
        carregarAtividades(); 
    }


    // --- Fun√ß√µes de Exibi√ß√£o de Atividades (Aluno - FIREBASE) ---

    window.carregarAtividades = async function() {
        const listaAtividadesElemento = document.getElementById('lista-atividades');
        const atividades = window.atividadesData || []; // Usa dados do listener
        
        if (atividades.length === 0) {
            listaAtividadesElemento.innerHTML = '<p class="empty-list-message">Nenhuma atividade cadastrada pelo professor.</p>';
            return;
        }

        const statusEnvio = await obterStatusEnvio(); // Busca status de envio atualizado
        const hojeTs = getTodayTimestamp();
        
        // Filtra as atividades futuras (ou de hoje)
        const atividadesFuturas = atividades.filter(a => dataParaTimestamp(a.dataEntrega) !== null && dataParaTimestamp(a.dataEntrega) >= hojeTs);
        
        if (atividadesFuturas.length === 0) {
            listaAtividadesElemento.innerHTML = '<p class="empty-list-message">Nenhuma atividade pendente ou futura.</p>';
            return;
        }

        let htmlAtividades = atividadesFuturas.map(a => {
            const isEnviada = statusEnvio[a.id] && statusEnvio[a.id].status === 'enviada';
            
            return `
                <div class="card ${isEnviada ? 'enviada' : ''}">
                    <h2 class="tarefa-texto">${a.nome} (${a.materia})</h2>
                    <p>Entrega: <strong>${a.dataEntrega}</strong></p>
                    
                    <div class="input-group" style="margin-top: 10px;">
                        <!-- O input type="file" √© apenas um placeholder visual neste ambiente de iframe -->
                        <input type="file" class="campo" ${isEnviada ? 'disabled' : ''} style="padding: 5px;">
                        
                        <button class="btn btn-action" 
                                onclick="confirmarEnvio('${a.id}')" 
                                ${isEnviada ? 'disabled' : ''}
                                style="width: auto; padding: 8px 10px; margin: 0; background: ${isEnviada ? '#4CAF50' : 'var(--color-primary)'}">
                            ${isEnviada ? '‚úì Enviada' : 'Confirmar Envio'}
                        </button>
                    </div>
                </div>
            `;
        }).join('');

        listaAtividadesElemento.innerHTML = htmlAtividades;
    }
    
  </script>
</body>
</html>