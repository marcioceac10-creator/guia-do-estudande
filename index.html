<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Guia do Estudante</title>
  
  <!-- Estilos CSS Embutidos (Garantindo um √∫nico arquivo) -->
  <style>
    /* Vari√°veis de Tema (Definidas no body[data-theme]) */
    :root {
      --color-primary: #ffcc00; /* Amarelo principal */
      --color-primary-dark: #ccaa00;
      --color-secundary: #ff4757; /* Vermelho/alerta */
      --color-alert: #ff6b6b; /* Cor de erro mais suave */
      --color-success: #10b981; /* Cor de sucesso */
    }

    /* Estilos do Tema Claro (Padr√£o) */
    body[data-theme="light"] {
      --color-background-main: #f4f6f8;
      --color-background-app: #ffffff;
      --color-background-darker: #f0f2f4;
      --color-text-main: #2c3e50;
      --color-text-card: #2c3e50;
      --color-border-card: #ecf0f1;
      --color-input-bg: #ecf0f1;
    }

    /* Estilos do Tema Escuro */
    body[data-theme="dark"] {
      --color-background-main: #2c3e50;
      --color-background-app: #34495e;
      --color-background-darker: #2f4154;
      --color-text-main: #ecf0f1;
      --color-text-card: #2c3e50;
      --color-border-card: #4a637d;
      --color-input-bg: #1e3040;
    }

    /* Estilos globais */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--color-background-main);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 80px;
      transition: background-color 0.3s;
      color: var(--color-text-main);
    }

    .top-bar {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background-color: #004080; /* Azul fixo para o header */
      color: #fff;
      display: flex;
      align-items: center;
      padding: 12px 25px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.25);
      z-index: 10;
    }

    .top-bar img {
      height: 40px;
      margin-right: 15px;
    }

    .top-bar h1 {
      font-size: 22px;
      font-weight: 600;
      flex-grow: 1;
      text-align: left;
      margin: 0;
    }

    .theme-toggle-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      padding: 5px;
      line-height: 1;
    }

    .app {
      width: 90%;
      max-width: 420px;
      background-color: var(--color-background-app);
      border-radius: 20px;
      padding: 25px;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
      transition: background-color 0.3s;
      margin-bottom: 30px;
    }

    .tela {
      display: none;
      animation: fadeIn 0.5s ease-out;
    }

    .tela.ativo {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    h1 {
      text-align: center;
      margin-bottom: 25px;
      font-size: 24px;
      color: var(--color-text-main);
      transition: color 0.3s;
    }
    
    h2 {
      font-size: 18px;
      margin-bottom: 5px;
      color: var(--color-primary-dark);
    }

    label {
      display: block;
      margin-bottom: 6px;
      font-weight: bold;
      font-size: 14px;
      color: var(--color-text-main);
    }

    .campo {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid var(--color-border-card);
      background-color: var(--color-input-bg);
      color: var(--color-text-main);
      margin-bottom: 15px;
      font-size: 16px;
      transition: border-color 0.3s, background-color 0.3s;
    }
    
    .campo:focus {
        border-color: var(--color-primary-dark);
        outline: none;
        box-shadow: 0 0 0 2px rgba(255, 204, 0, 0.2);
    }

    .btn {
      width: 100%;
      padding: 14px;
      margin: 8px 0;
      border: none;
      border-radius: 12px;
      background: var(--color-primary);
      color: var(--color-text-card); /* Cor escura para contrastar com o amarelo */
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .btn:hover:not([disabled]) {
      opacity: 0.9;
      transform: translateY(-1px);
      box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
    }
    
    .btn:disabled {
        background-color: #ccc;
        color: #666;
        cursor: not-allowed;
        box-shadow: none;
        transform: none;
    }
    
    .btn.voltar {
        background: var(--color-background-darker);
        color: var(--color-text-main);
        box-shadow: none;
        font-weight: 500;
        margin-top: 15px;
    }

    .btn.admin-btn {
      background: #333;
      color: white;
    }

    .card {
      background-color: var(--color-background-darker);
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 15px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      border-left: 5px solid var(--color-primary);
      transition: background-color 0.3s, border-color 0.3s;
    }
    
    .card.enviada {
        border-left: 5px solid var(--color-success);
        opacity: 0.8;
    }
    
    .card h2 {
        color: var(--color-primary-dark);
        font-size: 16px;
        margin-bottom: 4px;
    }
    
    .card p {
        color: var(--color-text-main);
        font-size: 14px;
    }

    .empty-list-message {
        text-align: center;
        color: #7f8c8d;
        padding: 20px;
        border: 1px dashed #bdc3c7;
        border-radius: 8px;
        margin-top: 20px;
    }
    
    /* Estilo para a caixa de mensagem de feedback (NOVO) */
    .feedback-message {
      padding: 12px;
      margin-bottom: 20px;
      border-radius: 8px;
      color: white;
      text-align: center;
      font-weight: bold;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      transition: background-color 0.3s;
    }
  </style>
</head>
<body data-theme="light">
  <header class="top-bar">
    <!-- Imagem de logo com fallback -->
    <img src="https://placehold.co/40x40/004080/fff?text=L" alt="logo" onerror="this.onerror=null; this.src='https://placehold.co/40x40/004080/fff?text=L';" />
    <h1>Guia do Estudante</h1>
    <!-- Bot√£o de Modo Escuro -->
    <button class="theme-toggle-btn" onclick="toggleTheme()">
      <span id="theme-icon">üåô</span>
    </button>
  </header>

  <main class="app">
    <!-- TELA DE SELE√á√ÉO: Login do Aluno E ADMIN -->
    <section class="tela ativo" id="tela-selecao">
      <h1 style="font-size: 28px; display: flex; align-items: center; justify-content: center; gap: 10px;">
         Acesso ao Guia
      </h1>
      <p style="text-align: center; margin-bottom: 25px; color: var(--color-secundary);">
        Preencha seus dados para come√ßar:
      </p>

      <!-- NOVO: Caixa de Mensagem de Feedback -->
      <div id="feedback-message" class="feedback-message" style="display: none;"></div>

      <label for="nome">Nome Completo:</label>
      <input type="text" id="nome" class="campo" placeholder="Ex: Maria Silva">

      <label for="curso">Curso:</label>
      <select id="curso" class="campo">
        <option value="" disabled selected>Escolha o curso</option>
        <option>Inform√°tica</option>
        <option>An√°lises Cl√≠nicas</option>
        <option>Nutri√ß√£o</option>
        <option>Edifica√ß√µes</option>
        <option>Qu√≠mica</option>
        <option>Meio Ambiente</option>
      </select>

      <label for="ano">Ano:</label>
      <select id="ano" class="campo">
        <option value="" disabled selected>Selecione o ano</option>
        <option>1¬∫ Ano</option>
        <option>2¬∫ Ano</option>
        <option>3¬∫ Ano</option>
      </select>

      <!-- BOT√ÉO DE ENTRADA DO ALUNO (Corrigido para usar a fun√ß√£o 'entrar') -->
      <button class="btn" onclick="entrar()" style="margin-top: 20px;">
        ACESSAR O MEU GUIA (ALUNO)
      </button>
      
      <!-- NOVO: Toggle para Acesso Admin -->
      <button class="btn admin-btn" id="btn-toggle-admin" onclick="toggleAdminLoginFields(event)" style="margin-top: 15px; background: #333; color: white;">
         Acesso Administrativo
      </button>
      
      <div id="admin-login-fields" style="display: none; margin-top: 20px; padding: 15px; border-radius: 12px; background: var(--color-background-darker);">
        <p style="text-align: center; margin-bottom: 15px; font-weight: bold; color: var(--color-text-main);">
            Insira a senha do Professor:
        </p>

        <label for="senha-admin">Senha:</label>
        <input type="password" id="senha-admin" class="campo" placeholder="Senha do Professor">

        <button class="btn btn-action" onclick="logarAdmin()" style="margin-top: 10px; background: linear-gradient(90deg, #ff6b6b, #ff4757);">
            ENTRAR NO PAINEL ADMIN
        </button>
      </div>

    </section>
    
    <!-- TELA INICIAL: ADICIONADO ALERTA DE NOTIFICA√á√ïES E NOVO BOT√ÉO -->
    <section class="tela" id="tela-inicial">
      <h1 id="info-aluno">Menu Principal</h1>
      
      <!-- CARD DE NOTIFICA√á√ïES/ALERTAS -->
      <div id="alertas-proximos" class="card" style="margin-bottom: 25px; display: none; border: 2px solid var(--color-secundary);">
        <!-- Conte√∫do din√¢mico inserido por JavaScript -->
      </div>
      
      <button class="btn" onclick="mudarTela('avisos')"> Mural de Avisos</button>
      <button class="btn" onclick="mudarTela('calendario')">Calend√°rio de Provas</button>
      <button class="btn" onclick="mudarTela('atividades')">Atividades para Entregar</button>
      <button class="btn" onclick="mudarTela('assuntos')">Assuntos</button>
      <button class="btn" onclick="mudarTela('recursos')">Recursos de Estudo</button> 
      <button class="btn" onclick="mudarTela('professores')">Professores e Contatos</button>
      <button class="btn voltar" onclick="mudarTela('selecao')">‚Üê Trocar Aluno/Curso</button>
    </section>
    
    <!-- TELA DE ADMINISTRA√á√ÉO: ADICIONADO BOT√ÉO DE LIMPEZA -->
    <section class="tela" id="tela-admin">
      <h1>Painel do Administrador</h1>
      <p>Selecione o que deseja cadastrar:</p>
      <button class="btn" onclick="mudarTela('adicionar-prova')">‚ûï Cadastrar Prova</button>
      <button class="btn admin-btn" onclick="mudarTela('adicionar-atividade')"> Cadastrar Atividade</button>
      <button class="btn admin-btn" onclick="mudarTela('adicionar-aviso')" style="background: linear-gradient(90deg, #10b981, #059669);"> Cadastrar Aviso</button>
      
      <!-- BOT√ÉO DE LIMPEZA: Cor original mantida (#e67e22) -->
      <button class="btn voltar" onclick="limparItensAntigos()" style="background: #e67e22; border: none; margin-top: 20px;"> Limpar Itens Antigos</button>
      
      <button class="btn voltar" onclick="mudarTela('inicial')" style="margin-top: 5px;">‚Üê Voltar ao Menu</button>
    </section>

    <!-- FORMUL√ÅRIO DE PROVA -->
    <section class="tela" id="tela-adicionar-prova">
      <h1>Cadastrar Nova Prova</h1>
      <label for="prova-data">Data (DD/MM):</label>
      <input type="text" id="prova-data" class="campo" placeholder="Ex: 25/11" maxlength="5">

      <label for="prova-materia">Mat√©ria:</label>
      <input type="text" id="prova-materia" class="campo" placeholder="Ex: Qu√≠mica">

      <label for="prova-assunto">Assunto:</label>
      <input type="text" id="prova-assunto" class="campo" placeholder="Ex: Balanceamento Qu√≠mico">

      <button class="btn" onclick="adicionarProva()">Salvar Prova</button>
      <button class="btn voltar" onclick="mudarTela('admin')">‚Üê Voltar</button>
    </section>
    
    <!-- FORMUL√ÅRIO: CADASTRO DE ATIVIDADE -->
    <section class="tela" id="tela-adicionar-atividade">
      <h1>Cadastrar Nova Atividade</h1>
      <label for="atividade-nome">Nome da Atividade:</label>
      <input type="text" id="atividade-nome" class="campo" placeholder="Ex: Resumo Cap. 5">

      <label for="atividade-materia">Mat√©ria:</label>
      <input type="text" id="atividade-materia" class="campo" placeholder="Ex: Portugu√™s">

      <label for="atividade-data-entrega">Data de Entrega (DD/MM):</label>
      <input type="text" id="atividade-data-entrega" class="campo" placeholder="Ex: 10/12" maxlength="5">

      <button class="btn" onclick="adicionarAtividade()">Salvar Atividade</button>
      <button class="btn voltar" onclick="mudarTela('admin')">‚Üê Voltar</button>
    </section>
    
    <!-- FORMUL√ÅRIO: CADASTRO DE AVISO (ADMIN) -->
    <section class="tela" id="tela-adicionar-aviso">
      <h1>Cadastrar Novo Aviso</h1>
      <label for="aviso-titulo">T√≠tulo:</label>
      <input type="text" id="aviso-titulo" class="campo" placeholder="Ex: Mudan√ßa de hor√°rio de aula">

      <label for="aviso-texto">Mensagem:</label>
      <textarea id="aviso-texto" class="campo" rows="4" placeholder="Detalhes do aviso..."></textarea>
      
      <button class="btn" onclick="adicionarAviso()" style="background: linear-gradient(90deg, #10b981, #059669); color: white;">Publicar Aviso</button>
      <button class="btn voltar" onclick="mudarTela('admin')">‚Üê Voltar</button>
    </section>

    <!-- TELA DE CALEND√ÅRIO: Conte√∫do est√°tico removido -->
    <section class="tela" id="tela-calendario">
      <h1>Calend√°rio de Provas</h1>
      <div id="lista-provas">
        <!-- Provas din√¢micas ser√£o inseridas aqui -->
        <p class="empty-list-message">Nenhuma prova cadastrada pelo Admin.</p>
      </div>
      <button class="btn voltar" onclick="mudarTela('inicial')">‚Üê Voltar</button>
    </section>
    
    <!-- TELA DO MURAL DE AVISOS (ALUNO) -->
    <section class="tela" id="tela-avisos">
      <h1>Mural de Avisos da Escola</h1>
      <div id="lista-avisos">
        <!-- Avisos din√¢micos ser√£o inseridos aqui -->
      </div>
      <button class="btn voltar" onclick="mudarTela('inicial')">‚Üê Voltar</button>
    </section>


    <!-- TELA: ATIVIDADES PARA ENTREGAR (ALUNO) -->
    <section class="tela" id="tela-atividades">
      <h1>Atividades para Entregar</h1>
      <div id="lista-atividades">
        <!-- Atividades cadastradas pelo Admin ser√£o inseridas aqui -->
      </div>
      <button class="btn voltar" onclick="mudarTela('inicial')">‚Üê Voltar</button>
    </section>

    <!-- TELA DE ASSUNTOS: Conte√∫do est√°tico removido -->
    <section class="tela" id="tela-assuntos">
      <h1>Assuntos por Mat√©ria</h1>
      <p style="margin-bottom: 20px;">Lista de t√≥picos essenciais para cada disciplina. Utilize como guia para revis√µes.</p>
      <ul id="lista-assuntos">
        <!-- Assuntos din√¢micos (mockados ou reais) ser√£o inseridos aqui -->
        <p class="empty-list-message">Conte√∫do de Assuntos ser√° cadastrado pelo Admin em uma futura atualiza√ß√£o.</p>
      </ul>
      <button class="btn voltar" onclick="mudarTela('inicial')">‚Üê Voltar</button>
    </section>

    <!-- TELA DE RECURSOS DE ESTUDO: Conte√∫do est√°tico removido -->
    <section class="tela" id="tela-recursos">
      <h1> Recursos de Estudo</h1>
      <p style="margin-bottom: 20px;">Materiais de apoio e links importantes fornecidos pelos professores.</p>
      <ul id="lista-recursos">
        <!-- Recursos din√¢micos (mockados ou reais) ser√£o inseridos aqui -->
        <p class="empty-list-message">Nenhum link ou material de apoio cadastrado.</p>
      </ul>
      <button class="btn voltar" onclick="mudarTela('inicial')">‚Üê Voltar</button>
    </section>

    <!-- TELA PROFESSORES: Contatos √öteis atualizados com o link da Ouvidoria -->
    <section class="tela" id="tela-professores">
      <h1>Professores e Contatos</h1>
      
      <h2 style="margin-top: 20px;">Contatos √öteis da Escola</h2>
      <ul id="lista-contatos-uteis">
        <li>Secretaria: (99) 9999-9999</li>
        <li>Coordena√ß√£o: (99) 8888-8888</li>
        <!-- LINK DA OUVIDORIA ATUALIZADO -->
        <li><a href="https://ouvidoria-cetep-lnab-yitb.onrender.com/" target="_blank">Ouvidoria da Escola (Clique aqui)</a></li> 
      </ul>

      <h2 style="margin-top: 20px;">Professores</h2>
      <ul id="lista-professores">
        <!-- Professores din√¢micos (mockados ou reais) ser√£o inseridos aqui -->
        <p class="empty-list-message">Nenhum professor cadastrado para este curso/ano.</p>
      </ul>

      <button class="btn voltar" onclick="mudarTela('inicial')">‚Üê Voltar</button>
    </section>
  </main>

  <script>
    // --- Configura√ß√µes e Chaves de Armazenamento ---
    const STORAGE_PROVAS_KEY = 'guiaEstudante_provas';
    const STORAGE_ATIVIDADES_KEY = 'guiaEstudante_atividades';
    const STORAGE_ENVIOS_KEY = 'guiaEstudante_envios';
    const STORAGE_USER_KEY = 'guiaEstudante_user';
    const STORAGE_THEME_KEY = 'guiaEstudante_theme';
    const STORAGE_AVISOS_KEY = 'guiaEstudante_avisos';
    const SENHA_ADMIN = "1234"; 

    // --- Fun√ß√µes de Feedback de Mensagem (NOVA) ---

    /**
     * Exibe uma mensagem de feedback para o usu√°rio.
     * @param {string} mensagem - O texto da mensagem.
     * @param {'success'|'error'} tipo - O tipo de mensagem para definir a cor.
     */
    function mostrarMensagem(mensagem, tipo = 'error') {
        const msgBox = document.getElementById('feedback-message');
        if (!msgBox) return; // Garante que o elemento existe

        msgBox.textContent = mensagem;
        msgBox.style.display = 'block';
        msgBox.style.backgroundColor = tipo === 'error' ? 'var(--color-alert)' : 'var(--color-success)';

        // Remove a mensagem ap√≥s 4 segundos
        setTimeout(() => {
            msgBox.style.display = 'none';
        }, 4000);
    }

    // --- Fun√ß√µes de Inicializa√ß√£o e Tema (Modo Escuro Restaurado) ---

    document.addEventListener('DOMContentLoaded', () => {
        loadTheme();
        loadUserInfo();
    });

    function loadTheme() {
        const savedTheme = localStorage.getItem(STORAGE_THEME_KEY) || 'light';
        document.body.setAttribute('data-theme', savedTheme);
        document.getElementById('theme-icon').textContent = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
    }

    function toggleTheme() {
        const currentTheme = document.body.getAttribute('data-theme');
        const newTheme = currentTheme === 'light' ? 'dark' : 'light';
        document.body.setAttribute('data-theme', newTheme);
        localStorage.setItem(STORAGE_THEME_KEY, newTheme);
        document.getElementById('theme-icon').textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
    }
    
    function loadUserInfo() {
        const userInfo = JSON.parse(localStorage.getItem(STORAGE_USER_KEY));
        if (userInfo) {
             document.getElementById('info-aluno').textContent = `Bem-vindo(a), ${userInfo.nome} (${userInfo.ano} - ${userInfo.curso})`;
             document.getElementById('nome').value = userInfo.nome;
             document.getElementById('curso').value = userInfo.curso;
             document.getElementById('ano').value = userInfo.ano;
             mudarTela('inicial', false);
             verificarAlertas();
        } else {
             mudarTela('selecao', false);
        }
    }


    // --- Fun√ß√µes de Navega√ß√£o e Autentica√ß√£o ---

    /**
     * Alterna a visibilidade dos campos de login do administrador.
     */
    function toggleAdminLoginFields(event) {
        event.preventDefault(); // Impede o comportamento padr√£o do bot√£o
        const fields = document.getElementById('admin-login-fields');
        const toggleBtn = document.getElementById('btn-toggle-admin');
        
        if (fields.style.display === 'none' || fields.style.display === '') {
            fields.style.display = 'block';
            toggleBtn.textContent = 'Ocultar Acesso Administrativo';
            toggleBtn.style.background = '#444'; 
        } else {
            fields.style.display = 'none';
            toggleBtn.textContent = ' Acesso Administrativo';
            toggleBtn.style.background = '#333';
        }
    }

    function logarAdmin() {
        const senhaInput = document.getElementById('senha-admin');
        const senha = senhaInput.value;

        if (senha === SENHA_ADMIN) {
            senhaInput.value = '';
            // Oculta os campos de login admin ap√≥s o sucesso
            document.getElementById('admin-login-fields').style.display = 'none';
            document.getElementById('btn-toggle-admin').textContent = ' Acesso Administrativo';
            document.getElementById('btn-toggle-admin').style.background = '#333';
            
            mostrarMensagem(' Acesso Admin liberado com sucesso!', 'success');
            setTimeout(() => mudarTela('admin', false), 500);
        } else {
            mostrarMensagem(" Senha incorreta. Acesso negado.", 'error');
            senhaInput.value = '';
        }
    }


    function mudarTela(telaId, checkAuth = true) {
      
      const telas = document.querySelectorAll('.tela');
      telas.forEach(tela => tela.classList.remove('ativo'));
      document.getElementById(`tela-${telaId}`).classList.add('ativo');
      
      // Limpa qualquer mensagem de feedback ao mudar de tela
      const msgBox = document.getElementById('feedback-message');
      if(msgBox) msgBox.style.display = 'none';
      
      if (telaId === 'inicial') {
        verificarAlertas();
      } else if (telaId === 'calendario') {
        carregarProvas();
      } else if (telaId === 'atividades') {
        carregarAtividades();
      } else if (telaId === 'avisos') { 
        carregarAvisos();
      }
    }

    /**
     * Fun√ß√£o corrigida para exibir feedback visual em caso de erro.
     */
    function entrar() {
      const nome = document.getElementById('nome').value.trim();
      const curso = document.getElementById('curso').value;
      const ano = document.getElementById('ano').value;
      
      // Valida√ß√£o: verifica se algum campo est√° vazio (o problema estava aqui, sem feedback visual)
      if (!nome || !curso || !ano || curso === '' || ano === '') {
        mostrarMensagem(' Por favor, preencha todos os campos (Nome, Curso e Ano).', 'error');
        return;
      }
      
      // Salva os dados do usu√°rio
      const userInfo = { nome, curso, ano };
      localStorage.setItem(STORAGE_USER_KEY, JSON.stringify(userInfo));

      document.getElementById('info-aluno').textContent = `Bem-vindo(a), ${nome} (${ano} - ${curso})`;
      
      mostrarMensagem(' Login efetuado com sucesso! Redirecionando...', 'success');
      
      // Delay para o usu√°rio ver a mensagem de sucesso
      setTimeout(() => {
          mudarTela('inicial', false);
      }, 500);
    }

    // --- Fun√ß√µes de Notifica√ß√£o e Datas ---

    /** * Converte data DD/MM para um timestamp, ajustando para o ano futuro se a data j√° passou.
     * @param {string} dataStr - Data no formato DD/MM.
     * @returns {number|null} Timestamp da data alvo √† meia-noite, ou null se formato inv√°lido.
     */
    function dataParaTimestamp(dataStr) {
      const partes = dataStr.split('/');
      if (partes.length !== 2) return null;
      const dia = parseInt(partes[0]);
      const mes = parseInt(partes[1]) - 1; // M√™s √© zero-based (0=Jan)
      
      const hoje = new Date();
      hoje.setHours(0, 0, 0, 0);

      const dataAlvo = new Date(hoje.getFullYear(), mes, dia);
      dataAlvo.setHours(0, 0, 0, 0);

      // Se a data alvo j√° passou no ano atual, ajusta para o pr√≥ximo ano.
      if (dataAlvo.getTime() < hoje.getTime()) {
          dataAlvo.setFullYear(dataAlvo.getFullYear() + 1);
      }
      return dataAlvo.getTime();
    }
    
    function getTodayTimestamp() {
        const hoje = new Date();
        hoje.setHours(0, 0, 0, 0);
        return hoje.getTime();
    }

    function verificarAlertas() {
      const hojeTs = getTodayTimestamp();
      
      // Intervalo de alerta: at√© 3 dias a partir de hoje
      const limiteAlerta = new Date(hojeTs);
      limiteAlerta.setDate(limiteAlerta.getDate() + 4); 
      const limiteAlertaTs = limiteAlerta.getTime();
      
      let provasProximas = 0;
      let atividadesProximas = 0;
      let atividadesPendentes = 0;
      
      // 1. Provas
      const provas = obterProvasSalvas();

      provas.forEach(p => {
        const provaTs = dataParaTimestamp(p.data);
        if (provaTs && provaTs >= hojeTs && provaTs < limiteAlertaTs) {
          provasProximas++;
        }
      });
      
      // 2. Atividades
      const atividades = obterAtividadesSalvas();
      const statusEnvio = obterStatusEnvio();

      atividades.forEach(a => {
        if (statusEnvio[a.id] !== 'enviada') {
            atividadesPendentes++;
            
            const atividadeTs = dataParaTimestamp(a.dataEntrega);
            if (atividadeTs && atividadeTs >= hojeTs && atividadeTs < limiteAlertaTs) {
              atividadesProximas++;
            }
        }
      });

      const alertaElemento = document.getElementById('alertas-proximos');
      let htmlAlerta = '<h2> Alertas de Organiza√ß√£o</h2>';
      let temAlerta = false;

      if (provasProximas > 0) {
        htmlAlerta += `<p>‚Ä¢  ${provasProximas} Prova(s) marcada(s) para os pr√≥ximos 3 dias. Estude!</p>`;
        temAlerta = true;
      }
      if (atividadesProximas > 0) {
        htmlAlerta += `<p>‚Ä¢  ${atividadesProximas} Atividade(s) com entrega nos pr√≥ximos 3 dias.</p>`;
        temAlerta = true;
      }
      if (atividadesPendentes > 0) {
        htmlAlerta += `<p>‚Ä¢  Voc√™ tem ${atividadesPendentes} atividade(s) pendente(s) no total.</p>`;
      }
      
      if (!temAlerta && atividadesPendentes === 0) {
        htmlAlerta = '<h2> Tudo em Ordem!</h2><p>Nenhuma prova ou entrega urgente para os pr√≥ximos dias.</p>';
        alertaElemento.style.borderColor = 'var(--color-success)';
      } else if (!temAlerta && atividadesPendentes > 0) {
        htmlAlerta = `<h2> Sem Urg√™ncia</h2><p>Voc√™ tem ${atividadesPendentes} atividade(s) pendente(s), mas sem prazo para os pr√≥ximos 3 dias.</p>`;
        alertaElemento.style.borderColor = 'var(--color-primary-dark)';
      } else {
        alertaElemento.style.borderColor = 'var(--color-alert)';
      }
      
      alertaElemento.innerHTML = htmlAlerta;
      alertaElemento.style.display = 'block';
    }


    // --- FUN√á√ÉO DE LIMPEZA GERAL (NOVA) ---

    function limparItensAntigos() {
        const hojeTs = getTodayTimestamp();
        let provasRemovidas = 0;
        let atividadesRemovidas = 0;
        let avisosRemovidos = 0;
        
        // 1. Limpa Provas Passadas
        let provas = obterProvasSalvas();
        const provasAtuais = provas.filter(p => {
            const provaTs = dataParaTimestamp(p.data);
            // Mant√©m se a data for hoje ou no futuro
            return provaTs !== null && provaTs >= hojeTs; 
        });
        provasRemovidas = provas.length - provasAtuais.length;
        salvarProvas(provasAtuais);
        
        // 2. Limpa Atividades Passadas (independentemente do status de envio)
        let atividades = obterAtividadesSalvas();
        const atividadesAtuais = atividades.filter(a => {
            const atividadeTs = dataParaTimestamp(a.dataEntrega);
            // Mant√©m se a data for hoje ou no futuro
            return atividadeTs !== null && atividadeTs >= hojeTs;
        });
        atividadesRemovidas = atividades.length - atividadesAtuais.length;
        salvarAtividades(atividadesAtuais);
        
        // 3. Limpa Avisos com mais de 30 dias
        let avisos = obterAvisosSalvos();
        const limiteDias = 30; // Avisos mais antigos que 30 dias ser√£o removidos
        
        const avisosAtuais = avisos.filter(a => {
            // A data do aviso √© salva no formato DD/MM/AAAA. Vamos parsear.
            const partes = a.data.split('/');
            if (partes.length !== 3) return true; // Mant√©m se o formato estiver errado
            
            const dia = parseInt(partes[0]);
            const mes = parseInt(partes[1]) - 1; 
            const ano = parseInt(partes[2]);
            const avisoDate = new Date(ano, mes, dia);
            
            const diferencaEmDias = (hojeTs - avisoDate.getTime()) / (1000 * 60 * 60 * 24);

            return diferencaEmDias <= limiteDias;
        });

        avisosRemovidos = avisos.length - avisosAtuais.length;
        salvarAvisos(avisosAtuais);


        let mensagem = `Limpeza conclu√≠da!
        
        - ${provasRemovidas} prova(s) passada(s) removida(s).
        - ${atividadesRemovidas} atividade(s) passada(s) removida(s).
        - ${avisosRemovidos} aviso(s) com mais de 30 dias removido(s).
        
        O Guia do Estudante est√° mais organizado!`;
        
        console.log(mensagem);
        // Feedback visual simples
        const btn = document.querySelector('#tela-admin .btn[onclick="limparItensAntigos()"]');
        btn.textContent = " Limpeza Conclu√≠da!";
        mostrarMensagem(' Limpeza Conclu√≠da!', 'success');
        
        setTimeout(() => {
            btn.textContent = " Limpar Itens Antigos";
        }, 3000);

        mudarTela('admin');
        verificarAlertas();
    }


    // --- Fun√ß√µes de Gest√£o de Provas (Admin/Aluno) ---

    function obterProvasSalvas() {
      const dados = localStorage.getItem(STORAGE_PROVAS_KEY);
      return dados ? JSON.parse(dados) : [];
    }

    function salvarProvas(provas) {
      localStorage.setItem(STORAGE_PROVAS_KEY, JSON.stringify(provas));
    }

    function adicionarProva() {
      const dataInput = document.getElementById('prova-data');
      const materiaInput = document.getElementById('prova-materia');
      const assuntoInput = document.getElementById('prova-assunto');

      const novaProva = {
        id: Date.now(),
        data: dataInput.value.trim(),
        materia: materiaInput.value.trim(),
        assunto: assuntoInput.value.trim()
      };

      if (!novaProva.data || !novaProva.materia || !novaProva.assunto) {
        mostrarMensagem(' Por favor, preencha todos os campos da prova.', 'error');
        return;
      }

      const provas = obterProvasSalvas();
      provas.push(novaProva);
      salvarProvas(provas);

      console.log(`Prova de ${novaProva.materia} em ${novaProva.data} adicionada com sucesso!`);
      mostrarMensagem(` Prova de ${novaProva.materia} salva!`, 'success');

      dataInput.value = '';
      materiaInput.value = '';
      assuntoInput.value = '';
      setTimeout(() => mudarTela('admin'), 500);
    }

    function carregarProvas() {
      const listaProvasElemento = document.getElementById('lista-provas');
      const provas = obterProvasSalvas();
      
      let htmlProvas = '';

      // Adiciona as provas salvas dinamicamente
      if (provas.length > 0) {
        // Ordena as provas por data (opcional, mas recomendado)
        provas.sort((a, b) => dataParaTimestamp(a.data) - dataParaTimestamp(b.data));

        provas.forEach(prova => {
          htmlProvas += `
            <div class="card">
              <h2>${prova.data} - ${prova.materia}</h2>
              <p>Assunto: ${prova.assunto}</p>
            </div>
          `;
        });
      } else {
        htmlProvas = `<p class="empty-list-message">Nenhuma prova cadastrada pelo Admin.</p>`;
      }
      
      listaProvasElemento.innerHTML = htmlProvas;
    }

    // --- Fun√ß√µes de Gest√£o de ATIVIDADES (Professor/Admin) ---

    function obterAtividadesSalvas() {
        const dados = localStorage.getItem(STORAGE_ATIVIDADES_KEY);
        return dados ? JSON.parse(dados) : [];
    }
    
    function salvarAtividades(atividades) {
        localStorage.setItem(STORAGE_ATIVIDADES_KEY, JSON.stringify(atividades));
    }

    function adicionarAtividade() {
        const nomeInput = document.getElementById('atividade-nome');
        const materiaInput = document.getElementById('atividade-materia');
        const dataEntregaInput = document.getElementById('atividade-data-entrega');

        const novaAtividade = {
            id: Date.now(),
            nome: nomeInput.value.trim(),
            materia: materiaInput.value.trim(),
            dataEntrega: dataEntregaInput.value.trim()
        };

        if (!novaAtividade.nome || !novaAtividade.materia || !novaAtividade.dataEntrega) {
            mostrarMensagem(' Por favor, preencha todos os campos da atividade.', 'error');
            return;
        }

        const atividades = obterAtividadesSalvas();
        atividades.push(novaAtividade);
        salvarAtividades(atividades);

        console.log(`Atividade "${novaAtividade.nome}" (${novaAtividade.materia}) cadastrada com sucesso! Data: ${novaAtividade.dataEntrega}`);
        mostrarMensagem(` Atividade "${novaAtividade.nome}" salva!`, 'success');

        nomeInput.value = '';
        materiaInput.value = '';
        dataEntregaInput.value = '';
        setTimeout(() => mudarTela('admin'), 500);
    }

    // --- Fun√ß√µes de Gest√£o de AVISOS (Professor/Admin) ---

    function obterAvisosSalvos() {
      const dados = localStorage.getItem(STORAGE_AVISOS_KEY);
      return dados ? JSON.parse(dados) : [];
    }

    function salvarAvisos(avisos) {
      localStorage.setItem(STORAGE_AVISOS_KEY, JSON.stringify(avisos));
    }

    function adicionarAviso() {
      const tituloInput = document.getElementById('aviso-titulo');
      const textoInput = document.getElementById('aviso-texto');
      
      const novoAviso = {
        id: Date.now(),
        titulo: tituloInput.value.trim(),
        texto: textoInput.value.trim(),
        // Salva a data de hoje no formato DD/MM/AAAA para compara√ß√£o de limpeza
        data: new Date().toLocaleDateString('pt-BR') 
      };

      if (!novoAviso.titulo || !novoAviso.texto) {
        mostrarMensagem(' Por favor, preencha o t√≠tulo e a mensagem do aviso.', 'error');
        return;
      }

      const avisos = obterAvisosSalvos();
      avisos.unshift(novoAviso); // Adiciona no in√≠cio para mostrar o mais novo primeiro
      salvarAvisos(avisos);

      console.log(`Aviso "${novoAviso.titulo}" publicado com sucesso!`);
      mostrarMensagem(` Aviso "${novoAviso.titulo}" publicado!`, 'success');

      tituloInput.value = '';
      textoInput.value = '';
      setTimeout(() => mudarTela('admin'), 500);
    }

    function carregarAvisos() {
      const listaAvisosElemento = document.getElementById('lista-avisos');
      const avisos = obterAvisosSalvos();

      if (avisos.length === 0) {
        listaAvisosElemento.innerHTML = '<p class="empty-list-message" style="color: var(--color-text-main);">Nenhum aviso geral publicado pela escola at√© o momento.</p>';
        return;
      }

      let htmlAvisos = avisos.map(aviso => {
          return `
              <div class="card card-aviso">
                  <h2 style="color: var(--color-primary-dark);">${aviso.titulo}</h2>
                  <p style="margin-bottom: 8px;">${aviso.texto.replace(/\n/g, '<br>')}</p>
                  <small style="display: block; text-align: right; color: var(--color-secundary); font-size: 11px;">Publicado em: ${aviso.data}</small>
              </div>
          `;
      }).join('');

      listaAvisosElemento.innerHTML = htmlAvisos;
    }


    // --- Fun√ß√µes de ENVIOS do Aluno ---

    function obterStatusEnvio() {
        const userInfo = JSON.parse(localStorage.getItem(STORAGE_USER_KEY));
        if (!userInfo || !userInfo.nome) return {};
        
        const envios = localStorage.getItem(STORAGE_ENVIOS_KEY);
        const allEnvios = envios ? JSON.parse(envios) : {};

        return allEnvios[userInfo.nome] || {};
    }

    function salvarStatusEnvio(atividadeId, status) {
        const userInfo = JSON.parse(localStorage.getItem(STORAGE_USER_KEY));
        if (!userInfo || !userInfo.nome) {
             console.error('Erro: Usu√°rio n√£o identificado para salvar o envio.');
             return;
        }

        const envios = localStorage.getItem(STORAGE_ENVIOS_KEY);
        const allEnvios = envios ? JSON.parse(envios) : {};
        
        if (!allEnvios[userInfo.nome]) {
             allEnvios[userInfo.nome] = {};
        }

        allEnvios[userInfo.nome][atividadeId] = status;
        
        localStorage.setItem(STORAGE_ENVIOS_KEY, JSON.stringify(allEnvios));
    }
    
    function confirmarEnvio(atividadeId) {
        console.log("Simula√ß√£o de Envio: Arquivo pronto para upload! Por favor, confirme o envio.");
        
        // Simula√ß√£o de confirma√ß√£o:
        salvarStatusEnvio(atividadeId, 'enviada');
        
        mostrarMensagem(' Atividade marcada como ENVIADA!', 'success');
        carregarAtividades();
        verificarAlertas(); // Atualiza os alertas
    }


    // --- Fun√ß√µes de Exibi√ß√£o de Atividades (Aluno) ---

    function carregarAtividades() {
        const listaAtividadesElemento = document.getElementById('lista-atividades');
        const atividades = obterAtividadesSalvas();
        const statusEnvio = obterStatusEnvio();
        
        if (atividades.length === 0) {
            listaAtividadesElemento.innerHTML = '<p class="empty-list-message">Nenhuma atividade cadastrada pelo professor.</p>';
            return;
        }

        // Ordena as atividades por data de entrega (pr√≥ximas primeiro)
        atividades.sort((a, b) => dataParaTimestamp(a.dataEntrega) - dataParaTimestamp(b.dataEntrega));

        let htmlAtividades = atividades.map(a => {
            const isEnviada = statusEnvio[a.id] === 'enviada';
            
            return `
                <div class="card ${isEnviada ? 'enviada' : ''}">
                    <h2 class="tarefa-texto">${a.nome} (${a.materia})</h2>
                    <p>Entrega: <strong>${a.dataEntrega}</strong></p>
                    
                    <div class="input-group" style="margin-top: 10px; display: flex; gap: 10px; align-items: center;">
                        <!-- O input type=file n√£o salva o arquivo, √© apenas visual -->
                        <input type="file" class="campo" ${isEnviada ? 'disabled' : ''} style="padding: 5px; flex-grow: 1; margin-bottom: 0;">
                        
                        <button class="btn btn-action" 
                                onclick="confirmarEnvio(${a.id})" 
                                ${isEnviada ? 'disabled' : ''}
                                style="width: auto; padding: 8px 10px; margin: 0; background: ${isEnviada ? 'var(--color-success)' : 'var(--color-primary)'}">
                            ${isEnviada ? '‚úì Enviada' : 'Confirmar Envio'}
                        </button>
                    </div>
                </div>
            `;
        }).join('');

        listaAtividadesElemento.innerHTML = htmlAtividades;
    }

  </script>
</body>
</html>
